# Database Scripts

This folder contains SQL Server database scripts for the Driver License Registration & Verification System.

## Script Execution Order

Run the scripts in the following order for a fresh database setup:

### 1. **01-create-database.sql**
Creates the `DriverLicenseDB` database.

```sql
sqlcmd -S localhost -i 01-create-database.sql
```

### 2. **02-create-tables.sql**
Creates all database tables (Users, Drivers, VerificationLogs).

```sql
sqlcmd -S localhost -d DriverLicenseDB -i 02-create-tables.sql
```

### 3. **03-create-constraints.sql**
Adds all constraints:
- Primary Keys (already in table definitions)
- Unique Constraints (Username, LicenseID)
- Foreign Keys (RegisteredBy, CheckedBy)
- Check Constraints (Status values, LicenseType)

```sql
sqlcmd -S localhost -d DriverLicenseDB -i 03-create-constraints.sql
```

### 4. **04-create-indexes.sql**
Creates indexes for performance optimization.

```sql
sqlcmd -S localhost -d DriverLicenseDB -i 04-create-indexes.sql
```

### 5. **05-seed-data.sql**
Inserts sample data for testing.

```sql
sqlcmd -S localhost -d DriverLicenseDB -i 05-seed-data.sql
```

### 6. **fix-passwords.sql**
Generates proper BCrypt password hashes for user accounts.

```sql
sqlcmd -S localhost -d DriverLicenseDB -i fix-passwords.sql
```

## Complete Setup (All-in-One)

Use the **schema.sql** file to run all steps at once:

```sql
sqlcmd -S localhost -i schema.sql
```

## Database Schema

### Tables

#### Users
Stores system users who can register drivers and verify licenses.

| Column | Type | Constraints |
|--------|------|-------------|
| UserID | INT | PRIMARY KEY, IDENTITY |
| Username | NVARCHAR(50) | NOT NULL, UNIQUE |
| PasswordHash | NVARCHAR(255) | NOT NULL |
| CreatedDate | DATETIME2 | NOT NULL, DEFAULT GETDATE() |
| Status | NVARCHAR(20) | NOT NULL, DEFAULT 'active', CHECK IN ('active', 'inactive') |

#### Drivers
Stores driver license information.

| Column | Type | Constraints |
|--------|------|-------------|
| DriverID | INT | PRIMARY KEY, IDENTITY |
| LicenseID | NVARCHAR(50) | NOT NULL, UNIQUE |
| FullName | NVARCHAR(100) | NOT NULL |
| DateOfBirth | DATE | NOT NULL |
| LicenseType | NVARCHAR(10) | NOT NULL, CHECK IN ('A', 'B', 'C', 'D', 'E') |
| ExpiryDate | DATE | NOT NULL |
| QRRawData | NVARCHAR(MAX) | NULL |
| OCRRawText | NVARCHAR(MAX) | NULL |
| CreatedDate | DATETIME2 | NOT NULL, DEFAULT GETDATE() |
| RegisteredBy | INT | NOT NULL, FK → Users(UserID) |

#### VerificationLogs
Audit trail for all license verification attempts.

| Column | Type | Constraints |
|--------|------|-------------|
| LogID | INT | PRIMARY KEY, IDENTITY |
| LicenseID | NVARCHAR(50) | NOT NULL |
| VerificationStatus | NVARCHAR(20) | NOT NULL, CHECK IN ('real', 'fake', 'expired') |
| CheckedBy | INT | NOT NULL, FK → Users(UserID) |
| CheckedDate | DATETIME2 | NOT NULL, DEFAULT GETDATE() |

## Relationships

```
Users (1) ──< (N) Drivers [RegisteredBy]
Users (1) ──< (N) VerificationLogs [CheckedBy]
```

## Indexes

### Users Table
- `IX_Users_Username` - For login queries
- `IX_Users_Status` - For filtering active users
- `IX_Users_CreatedDate` - For reporting

### Drivers Table
- `IX_Drivers_LicenseID` - For verification lookups
- `IX_Drivers_RegisteredBy` - For user activity tracking
- `IX_Drivers_CreatedDate` - For date-based queries
- `IX_Drivers_ExpiryDate` - For finding expired licenses
- `IX_Drivers_LicenseType_ExpiryDate` - Composite index

### VerificationLogs Table
- `IX_VerificationLogs_LicenseID` - For verification history
- `IX_VerificationLogs_CheckedBy` - For user activity tracking
- `IX_VerificationLogs_CheckedDate` - For date-based queries
- `IX_VerificationLogs_Status` - For filtering
- `IX_VerificationLogs_Status_CheckedDate` - Composite index

## Default Credentials

After running the seed data and fix-passwords scripts:

- **Username:** admin
- **Password:** Admin@123

## Connection String

Update your `appsettings.json` with:

```json
"ConnectionStrings": {
  "DefaultConnection": "Server=localhost;Database=DriverLicenseDB;Trusted_Connection=True;TrustServerCertificate=True;MultipleActiveResultSets=true"
}
```

## Notes

- All tables use `IDENTITY(1,1)` for auto-incrementing primary keys
- Foreign keys use `ON DELETE NO ACTION` to prevent cascading deletes
- Timestamps use `DATETIME2` for better precision
- Password hashes must be BCrypt format (generated by fix-passwords.sql)
